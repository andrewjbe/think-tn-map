---
title: "Think Tennessee Data Map"
subtitle: "`r params$county` County Fact Sheet"
format:
  ojo-report-template-html: default
# Formatting options -----------------------------------------------------------
logo: "www/thinktennessee-logo-white.png" # Other options are in the /www/ directory
number-sections: true
smooth-scroll: true
title-block-banner: "#1a884a" # The background color for the header banner
title-block-banner-color: "white" # The text color for the header banner
fontcolor: "black" # Default text color for the body
linkcolor: "#1a884a" # Default link color for the body
toc: false # This should be 'false' if your end goal is a PDF 
knitr: 
  opts_chunk: 
    fig.align: center # These are the default chunk options
    echo: false
    warning: false
    message: false
params:
  county: "Sevier"
# Remember that there are other formatting options in /_extensions/ojo-report-template/custom.scss
# You can also edit the header structure in /_extensions/ojo-report-template/title-block.html
# Document info ----------------------------------------------------------------
# author: Analyst
# date: last-modified
# description: |
#   This is where you can write a brief description of the publication if needed.
#   If you don't need it for your current project, you can just delete this parameter.
# abstract-title: "Executive Summary"
# abstract: |
#   This is where we'd write an abstract / executive summary. You can change the title
#   for this section by changing the `abstract-title` parameter, and you can 
#   delete the parameter if you don't need it.
---

```{r}

# To render to PDF after you've rendered your .html document:
# pagedown::chrome_print("./inst/county-summary-pdf/county-summary-pdf.html",
#                        "./inst/county-summary-pdf/county-summary-pdf.pdf", format = "pdf")

library(tidyverse)
library(ggthemes)
library(sf)
library(gt)
library(janitor)
library(here)
library(bslib)
library(htmltools)

options(scipen=999)

# Data -------------------------------------------------------------------------
main_ds <- read_csv("./data/data-clean.csv") |>
  filter(county == params$county)

ds_info <- read_csv("./data/data-info.csv") |>
  clean_names()

tn_county_seats <- read_csv("./data/tn-county-info.csv") |>
  clean_names() |>
  transmute(
    county = str_remove_all(county, " County"), 
    county_seat
    ) 

supp_age <- read_csv("data/supp-data-age.csv") |>
  mutate(county = str_remove(county, " County, Tennessee"))
supp_debt <- read_csv("data/supp-data-debt.csv") |>
  clean_names()
supp_housing <- read_csv("data/supp-data-housing.csv") |>
  clean_names()
supp_income <- read_csv("data/supp-data-income.csv") |>
  clean_names() |>
  mutate(county = str_remove(county, " County, Tennessee"))
supp_race <- read_csv("data/supp-data-race.csv") |>
  mutate(county = str_remove(county, " County, Tennessee"))
supp_turnout <- read_csv("data/supp-data-turnout.csv") |>
  clean_names()
supp_unemployment <- read_csv("data/supp-data-unemployment.csv") |>
  mutate(county = str_remove(county, " County, Tennessee"))

# Format metric ----------------------------------------------------------------
format_metric <- function(x, format, diff = FALSE) {
  
  if (format == "percent") {
    y <- paste0(round(100* x, 2), "%")
  } else if (format == "number") {
    y <- format(round(x, 2), big.mark = ",")
  } else if (format == "dollar" & x < 0) {
    y <- paste0("-$", format(round(-x, 2), big.mark = ","))
  } else if (format == "dollar" & x >= 0) {
    y <- paste0("$", format(round(x, 2), big.mark = ","))
  } else if (format == "per_1") {
    y <- paste0(format(round(x, 2), big.mark = ","), " to 1")
  } else if (format == "per_1k") {
    y <- paste0(format(round(x, 2), big.mark = ","), " per 1k")
  } else if (format == "per_100k") {
    y <- paste0(format(round(x, 2), big.mark = ","), " per 100k")
  } else if (format == "ratio") {
    y <- paste0("1 to ", format(round(x, 2), big.mark = ","))
  } else {
      y <- "ERROR!"
  }
  
  if ((x > 0 | is.na(x)) & diff) {
    y <- paste0("+", y)
  }
  
  return(y)
  
}

# The stat value boxes ---------------------------------------------------------
stat_callout <- function(v) {
  
  metric_value <- main_ds |> 
    pull(var = v) |> 
    format_metric(format = ds_info |> 
                    filter(variable == v) |> 
                    pull(var = format)
    )
  
  metric_rank <- main_ds |>
    pull(var = paste0(v, "_rank"))
                  
  metric_name <- ds_info |>
    filter(variable == v) |>
    pull(var = metric_title)
  
  metric_description <- ds_info |>
    filter(variable == v) |>
    pull(var = description)

  
  value_box(
    title = HTML(paste0("<b>", metric_name, "</b>")),
    value = metric_value,
    showcase_layout = showcase_left_center(max_height = "50px"),
    showcase = HTML(paste0("<h1><b>", "#", metric_rank, "</h1></b><i>in TN</i>")),
    #
    HTML(paste0("<i>", metric_description, "</i>")),
    fill = FALSE,
    class = "andrew-box"
  )
  
}

tag("style", 
     ".bslib-value-box .value-box-area{
     padding: 0;
     }
    .bslib-value-box {
    border: 0px !important;
    }
    .bslib-value-box .value-box-showcase {
    margin-top: 0px;
    }
    .bslib-value-box .value-box-value {
    font-size: 1rem;
    font-weight: bold;
    }
    .value-box-showcase h1 {
    margin: 0px !important;
    }")

```

:::: {.columns}

::: {.column width="60%"}

## `r params$county` County Summary

:::

::: {.column width="40%"}

```{r county_map, fig.height=1,fig.width=4}
# Map w/ county filled in ------------------------------------------------------
county_shape <- read_rds("./data/tn-counties.rds") |>
  rename(county = NAME)
given_county_shape <- county_shape |>
  filter(county == params$county)

ggplot(county_shape) +
  # annotation_map_tile(zoom = 8, zoomin = -1) +
  geom_sf(fill = NA, color = "black") +
  geom_sf(data = given_county_shape, fill = "red", alpha = 0.5) +
  theme_map() 
```

:::

::::

This report provides an overview of `r params$county` County's demographic, economic, and social makeup, in order to provide additional context for the metrics in the interactive map. The county seat of `r params$county` is `r tn_county_seats |> filter(county == params$county) |> pull(var = county_seat)`, Tennessee.

### Demographics

:::: {.columns}

::: {.column width="50%"}

```{r race, fig.height = 3, fig.width = 4}
supp_race_total <- supp_race |>
  select(-c(starts_with("n_"), "p_hispanic_or_latino", "p_not_hispanic_latino")) |>
  filter(county == "total") |>
  pivot_longer(-county)

supp_race |>
  select(-c(starts_with("n_"), "p_hispanic_or_latino", "p_not_hispanic_latino")) |>
  # mutate(across(starts_with("p_"), ~parse_number(.x))) |>
  # janitor::adorn_totals("col")
  filter(county == params$county) |>
  pivot_longer(-county) |>
  rbind(supp_race_total) |>
    mutate(
    name = case_when(
      name == "p_white" ~ "White",
      name == "p_black_or_african_american" ~ "Black or\nAfrican American",
      name == "p_other" ~ "Other Race",
      name == "p_two_or_more" ~ "Two or\nMore Races",
      TRUE ~ name
    )
  ) |>
  mutate(
    value = parse_number(value) / 100
  ) |>
  ggplot(aes(x = name, y = value, fill = county)) +
  geom_col(position = "dodge") +
    labs(
    title = "Race Distribution",
    x = "Category",
    y = "",
    ) +
  scale_y_continuous(limits = c(0 , NA),
                     labels = scales::percent) +
  scale_fill_manual(name = "", 
                    labels = c(paste(params$county, "County"), "Tennessee"),
                    values = c("#1a884a", "#f8b43c")
  ) +
  ggthemes::theme_excel_new() +
  theme(
    legend.position = "none"
  )


```

:::

::: {.column width="50%"}

```{r age, fig.height = 3, fig.width = 4}
supp_age_total <- supp_age |>
  filter(county == "total") |>
  select(-c(starts_with("n_"), "p_total")) |> 
  pivot_longer(-county)

supp_age |> 
  filter(county == params$county) |>
  select(-c(starts_with("n_"), "p_total")) |>
  pivot_longer(-county) |>
  rbind(supp_age_total) |>
  mutate(
    name = case_when(
      name == "p_14_and_under" ~ "14 and\nUnder",
      name == "p_15_24" ~ "15-24",
      name == "p_25_34" ~ "25-34",
      name == "p_35_44" ~ "35-44",
      name == "p_45_54" ~ "45-54",
      name == "p_55_64" ~ "55-64",
      name == "p_65_plus" ~ "65+",
      TRUE ~ name
    )
  ) |>
  mutate(
    value = parse_number(value) / 100
  ) |>
  ggplot(aes(x = name, y = value, fill = county)) +
  geom_col(position = "dodge") +
  labs(
    title = "Age Distribution",
    x = "Age Group",
    y = "",
  ) +
  scale_y_continuous(limits = c(0 , NA),
                     labels = scales::percent) +
  scale_fill_manual(name = "", 
                    labels = c(paste(params$county, "County"), "Tennessee"),
                    values = c("#1a884a", "#f8b43c")
  ) +
  # scale_x_discrete(guide = guide_axis(angle = 25)) +
  ggthemes::theme_excel_new() +
  theme(
    legend.position = "none"
  )

```

:::

::::

```{r income, fig.height = 3, fig.width = 8}
supp_income_total <- supp_income |>
  select(-total) |>
  filter(county == "total") |>
  pivot_longer(-county)

supp_income |>
  select(-c("total")) |>
  # mutate(across(starts_with("p_"), ~parse_number(.x))) |>
  # janitor::adorn_totals("col")
  filter(county == params$county) |>
  pivot_longer(-county) |>
  rbind(supp_income_total) |>
  mutate(
    name = case_when(
      name == "less_than_24_999" ~ "$24,999 or Under",
      name == "x25_000_to_49_999" ~ "$25,000 - $49,999",
      name == "x50_000_to_74_999" ~ "$50,000 - $74,999",
      name == "x75_000_to_99_999" ~ "$75,000 - $99,999",
      name == "x100_000_or_more" ~ "$100,000 or More",
      TRUE ~ name
    )
  ) |>
  mutate(
    value = parse_number(value) / 100,
    name = factor(name,
                  levels = c("$24,999 or Under", "$25,000 - $49,999",
                             "$50,000 - $74,999", "$75,000 - $99,999",
                             "$100,000 or More"))
  ) |> 
  ggplot(aes(x = name, y = value, fill = county)) +
  geom_col(position = "dodge") +
    labs(
    title = "Income Distribution",
    x = "Category",
    y = "",
    ) +
  scale_y_continuous(limits = c(0 , NA),
                     labels = scales::percent) +
  scale_fill_manual(name = "", 
                    labels = c(paste(params$county, "County"), "Tennessee"),
                    values = c("#1a884a", "#f8b43c")
  ) +
  ggthemes::theme_excel_new() +
  theme(
    legend.position = "bottom"
  )

```

{{< pagebreak >}}

### Economy and Working Families

Selected metrics related to the **economy and working families** of `r params$county` County are shown below.

```{r economy}
econ_callouts <- list(
  stat_callout("employment_growth"),
  stat_callout("wages_salaries"),
  stat_callout("cost_of_living"),
  stat_callout("poverty_rate_all"),
  stat_callout("food_stamps_all_households"),
  stat_callout("wage_gap")
)

layout_column_wrap(
  !!!econ_callouts,
  fill = FALSE,
  width = 0.5,
  heights_equal = "row"
)
```

### Debt and Household Finances

Selected metrics related to **debt and household finances** in `r params$county` County are shown below.

```{r finances}
finances_callouts <- list(
  stat_callout("bankruptcy_per_100k"),
  stat_callout("debt_in_collections_any"),
  stat_callout("debt_income_ratio"),
  stat_callout("credit_score")
)

layout_column_wrap(
  !!!finances_callouts,
  fill = FALSE,
  width = 0.5,
  heights_equal = "row"
)
```

### Civic Engagement and Criminal Justice

Selected metrics related to **civic engagement and criminal justice** in `r params$county` County are shown below.

```{r civics}
civic_callouts <- list(
  stat_callout("poll_stations_to_voters_ratio"),
  stat_callout("graduation_rate_all"),
  stat_callout("incarcerated_per_100k"),
  stat_callout("firearm_fatalities_per_100k")
)

layout_column_wrap(
  !!!civic_callouts,
  fill = FALSE,
  width = 0.5,
  heights_equal = "row"
)
```

### Affordability

Selected metrics related to **affordability and cost of living** in `r params$county` County are shown below.

```{r affordability}
afford_callouts <- list(
  stat_callout("renter_cost_burdened"),
  stat_callout("median_rent_increase"),
  stat_callout("home_owner_cost_burdened"),
  stat_callout("min_wage_work_hours_2br_affordability"),
  stat_callout("child_care_cost"),
  stat_callout("average_commute_time"),
  stat_callout("injury_crash_per_1k"),
  stat_callout("energy_burden")
)

layout_column_wrap(
  !!!afford_callouts,
  fill = FALSE,
  width = 0.5,
  heights_equal = "row"
)
```